# OpenSearch 중복 제거 스크립트

OpenSearch의 `syld_gpt` 인덱스에서 `page_content` 기준으로 중복된 문서를 제거하는 스크립트입니다.

## 기능

- `page_content` 필드를 기준으로 중복 문서 검색
- 중복 문서 중 하나만 유지하고 나머지 삭제
- Dry-run 모드로 삭제 전 미리 확인 가능
- 배치 처리로 대용량 데이터 효율적 처리

## 설치

필요한 패키지 설치:

```bash
pip install opensearch-py python-dotenv tqdm
```

## 환경 변수 설정

`.env` 파일에 다음 환경 변수를 설정하세요:

```env
OPENSEARCH_HOST=localhost
OPENSEARCH_PORT=9200
OPENSEARCH_USER=admin
OPENSEARCH_PASSWORD=admin
OPENSEARCH_USE_SSL=false
```

## 사용법

### 1. 기본 사용 (Dry-run 모드)

```bash
python deduplicate_opensearch.py
```

기본적으로 dry-run 모드로 실행되어 실제 삭제 없이 중복 분석 결과만 보여줍니다.

### 2. 실제 삭제 수행

스크립트 실행 후 확인 메시지가 나타나면 `yes`를 입력하면 실제로 중복 문서가 삭제됩니다.

## 동작 방식

1. **스캔 단계**: OpenSearch의 Scroll API를 사용하여 모든 문서를 스캔합니다.
2. **중복 검색**: `page_content` 필드를 기준으로 중복된 문서를 찾습니다.
3. **Dry-run**: 삭제될 문서 목록을 미리 보여줍니다.
4. **삭제 단계**: 사용자 확인 후 Bulk API를 사용하여 중복 문서를 배치로 삭제합니다.

## 전략 옵션

현재 스크립트는 `keep_strategy="first"`로 설정되어 있어, 각 중복 그룹에서 첫 번째 문서만 유지합니다.

다른 전략을 사용하려면 코드에서 `keep_strategy` 파라미터를 수정하세요:
- `"first"`: 첫 번째 문서 유지 (기본값)
- `"last"`: 마지막 문서 유지

## 주의사항

⚠️ **중요**:
- 삭제 작업은 되돌릴 수 없습니다. 반드시 dry-run 모드로 먼저 확인하세요.
- 대용량 인덱스의 경우 처리 시간이 오래 걸릴 수 있습니다.
- 삭제 전에 인덱스 백업을 권장합니다.

## 예시 출력

```
============================================================
OpenSearch 중복 제거 스크립트
============================================================
인덱스: syld_gpt

📊 현재 인덱스 문서 수: 10,000

============================================================
1단계: 중복 분석 (DRY RUN)
============================================================
📖 'syld_gpt' 인덱스의 모든 문서를 스캔하는 중...
문서 스캔: 100%|████████████| 10000/10000 [00:30<00:00, 333.33it/s]

📊 중복 분석 결과:
   - 중복된 page_content 개수: 500
   - 삭제될 문서 개수: 1,200

⚠️  DRY RUN 모드: 실제로 삭제하지 않습니다.
   실제 삭제를 원하면 dry_run=False로 설정하세요.

📋 시뮬레이션 결과:
   - 삭제될 문서 ID 개수: 1,200
   - 유지될 문서 ID 개수: 500
```

